<html>

<style>
    .form-group {
        padding: 1em;
        border-bottom: 1px solid #dadada;
    }
    
    .form-field {
        width: 100%;
        padding: 4px;
        height: 32px;
    }
    
    .messages {
        padding: 1em;
    }
    
    .messages p {}
    
    .hero {
        padding: 1em;
    }
</style>

<body>

    <div class="hero">
        <h1>thor-io.vnext</h1>
        <p>A small RTCDataChannel example</p>
    </div>
    <div class="form-group">
        <input type="text" id="im-text" class="form-field">
    </div>

    <div class="messages">
    </div>


    
    <script src="/src/client/thor-io.client.js ">
    </script>

    <script>
        var $ = function(selector, el) {
            if (!el) el = document;
            return el.querySelector(selector);
        }

        var appendMessage = function(msg) {
            var p = document.createElement("p");
            p.textContent = msg.text;
            $(".messages").insertBefore(p,$(".messages").firstChild);
        };

        var rtc, dc
        document.addEventListener("DOMContentLoaded", function() {
            var client = new ThorIO.Client.Factory(location.origin.replace(/^http/, 'ws'), ["contextBroker"]);

            client.OnOpen = function(brokerProxy) {
                    console.log("..",brokerProxy);
                rtc = new ThorIO.Client.WebRTC(brokerProxy, {
                    iceServers: [{
                        urls: "stun:stun.l.google.com:19302"
                    }]
                });

                dc = rtc.CreateDataChannel("foo")

                dc.OnOpen = function(event,peerId) {
                    console.log("data channel open",peerId)
                };
                dc.OnClose = function(event,peerId) {
                    console.log("data channel close ",peerId);
                };

                $("#im-text").addEventListener("keyup", function(evt) {
                    if (evt.keyCode === 13) {
                            evt.preventDefault();
                            var msg = {
                                text: this.value
                            };
                        dc.Invoke("chatMessage", msg);
                        appendMessage(msg);
                        this.value = "";
                        }
                });
                // When a chatMessage is recived, show it to the user
                dc.On("chatMessage", function(message) {
                    appendMessage(message);
                });

                rtc.OnContextChanged = function(data) {
                    rtc.ConnectContext()
                };
                rtc.OnContextCreated = function(data) {
                    rtc.ChangeContext("foo ");
                };

                // connect to the Broker

                brokerProxy.Connect();


            };
        });
    </script>

</body>

</html>