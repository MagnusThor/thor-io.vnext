<html>
<style>

    #local{
        position:absolute;
        right:10px;
        bottom:10px;
        max-width:180px;
    }

    #videos video{
        display:inline;
        margin-right:10px;
    }

</style>
<body>
    <h1>Simple 1-many WebRTC "conference app" </h1>
    <div>
        <p>
    Share the url with 1-many friends.  If you are doing a local test open your browser windows in incognition mode.
    </p>
    <button id="call">Start conference</button>

    </div>
    <div>
    <video id="local" autoplay controls"></video>
    </div>
  
    <div id="videos">

    </div>
        
   
    <script src="//cdnjs.cloudflare.com/ajax/libs/adapterjs/0.13.3/adapter.min.js"></script>
    <script src="/src/thor-io.client.js">
    </script>
    <script>

     

    var createVideoElement = function(stream,peer){
        var el = document.createElement("video");
        el.setAttribute("id", stream.id);
        el.setAttribute("autoplay","autoplay√ü");
        attachMediaStream(el, stream);
        return el;
    };

        var rtc;

        document.addEventListener("DOMContentLoaded", function() {
          
            var client = new ThorIOClient.Factory(location.origin.replace(/^http/, 'ws'), ["broker"], {});
              client.OnOpen = function(broker) {
                rtc = new ThorIOClient.WebRTC(broker,{
                    iceServers:[
                        {
                        url:"stun:stun.l.google.com:19302"
                        }
                    ]
                });
                var constraints = {
                    video: {
                        mandatory: {
                            maxWidth: 320,
                            maxHeight: 180
                        }
                    },
                    audio: true,
                };

                navigator.getUserMedia(constraints, function(stream) {
                    rtc.addLocalStream(stream);
                         attachMediaStream(document.querySelector("#local"),stream);

                }, function(err) { console.log("gum error", err);
                });

                document.querySelector("#call").addEventListener("click", function(){
                    broker.Invoke("connectContext", {}, "broker");
                });
                
                rtc.onRemoteStream = function(stream,connection) {
                    document.querySelector("#videos").appendChild(createVideoElement(stream,connection));
                };
                rtc.remoteStreamlost = function(streamId,peerId){
                    console.log("streamLost",arguments); // remove the video element
                };
                broker.On("contextChanged", function(data) {
                 location.hash = data.context;
                });
                broker.On("connectTo", function(peers) {
                    rtc.connect(peers);
                });
                broker.On("contextCreated" , function(data) {
                    rtc.localPeerId = data.peerId;

                    // create a new "room/context" it a #hash dont exist in the url...
                    var context = location.hash || Math.random().toString(36).replace(/[^a-z]+/g, '').substr(0, 10);

                   

                    broker.Invoke("changeContext",{context: context.replace("#","")},"broker");
                });
                broker.Connect();
            };
        });
    </script>

</body>

</html>