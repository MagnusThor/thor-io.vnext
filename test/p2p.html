<html>
<link href="css/default.css" rel="stylesheet" type="text/css">
<link href='//fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<body>
    <section>
    <div id="hero" class="">
    <h1>A Simple 1-many WebRTC "conference app" demo built on thor-io.vnext </h1>
    <div>
    <p>
    Share the url with 1-many friends.  If you are doing a local test open your browser windows in incognition mode.
    </p>
    <button id="call">Start conference</button>
    </div>
    </div>
    
    <video id="local" autoplay muted></video>
    
    <div id="fullscreen-video">
        <video id="main-video">
       </video>
    </div>
    <div id="videos">
    </div>
    </section>
    <footer>
        <div id="im-messages">

            </div>
        <input type="text" id="im-text" placeholder="Send an instant message to all ...">
        </footer>
   
    <!--<script src="//cdnjs.cloudflare.com/ajax/libs/adapterjs/0.13.3/adapter.min.js"></script>-->
    <script src="adapter.js">
    </script>   
    <script src="/src/client/thor-io.client.js">

    </script>

  
    <script>

    var $ = function(selector,el){
        if(!el) el = document;
        return el.querySelector(selector);
    }

    var createVideoElement = function(stream,peer){
        var el = document.createElement("video");
        el.setAttribute("id", stream.id);
        el.setAttribute("autoplay","autoplay");
        el.addEventListener("click",requestFullscreen);
        attachMediaStream(el, stream);
        attachMediaStream($("#main-video"), stream);
        return el;
    };

    var requestFullscreen = function(evt){
        var el = evt.target;
        $("#main-video").src = evt.target.src;
    }

        var rtc;
        document.addEventListener("DOMContentLoaded", function() {
            var client = new ThorIO.Factory(location.origin.replace(/^http/, 'ws'), ["broker"]);

            // we connected to the server (.Engine) , onOpen will give us the channels to the Controllers, in this 
            // case we are specified  just the broker (BrokerController.ts ) 
              client.OnOpen = function(brokerProxy) {
                // todo: add TURN server's to the config, to ensure "all" can connect..
                rtc = new ThorIO.WebRTC(brokerProxy,{
                    iceServers:[
                        {
                            url: "stun:stun.l.google.com:19302"
                        }
                    ]
                });

                var constraints = {
                    video: {
                        mandatory: {
                            maxWidth: 1280,
                            maxHeight: 720
                        }
                    },
                    audio: true,
                };
                // query for media access using the constraints , in this case audio and 720p video
                if(navigator.getUserMedia){
                    navigator.getUserMedia(constraints, function(stream) {
                        rtc.addLocalStream(stream);

                 
                        attachMediaStream($("#local"),stream);
                    },function(err){
                         console.log("getUserMedia error", err);
                    });
                }

                // start the conference
                $("#call").addEventListener("click", function(){
                    brokerProxy.Invoke("connectContext", {}, "broker");
                    $("#hero").classList.add("hide");
                });
                

                $("#im-text").addEventListener("keyup",function(evt){
                        if(evt.keyCode === 13){
                            brokerProxy.Invoke("instantMessage", {
                                text: (new Date()).toTimeString().substring(0,5) + " : " + this.value // just a simple message
                            },"broker");
                            this.value = ""
                        }
                });

                // someone connected and we got a new paricipant√ü
                rtc.onRemoteStream = function(stream,connection) {
                        $("#hero").classList.add("hide")
                    $("#videos").appendChild(createVideoElement(stream,connection));
                };
                
                // we lost one of the remote streams, so lets remove it
                rtc.remoteStreamlost = function(streamId,peerId){
                    console.log("streamLost",arguments);  //  todo: find the vido using the peerId, and remove the element
                };
                // When we change context, this event will fire...
                brokerProxy.On("contextChanged", function(data) {
                 location.hash = data.context;
                });
                brokerProxy.On("instantMessage", function(data){
                        var im = document.createElement("p");
                        im.textContent = data.text;
                        var parent =  $("#im-messages");
                       parent.insertBefore(im,parent.firstChild);

                });
                // fires when 'connectContext' is called, in this case we just connect to them, by calling .connect(arrPeers)
                brokerProxy.On("connectTo", function(peers) {
                    rtc.connect(peers);
                });

                // When we connect, we got our own context / room ... if we got a "hash" value, use that , otherwise generate a new room..
                brokerProxy.On("contextCreated" , function(data) {
                    rtc.localPeerId = data.peerId;
                    // create a new "room/context" using the #hash 'parameter' if it exists, otherwise a random one..
                    var context = location.hash || Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0, 10);
                    brokerProxy.Invoke("changeContext",{context: context.replace("#","")},"broker");
                });
                brokerProxy.Connect();
            };
        });
    </script>

</body>

</html>