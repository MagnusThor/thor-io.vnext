<html>

<body>

    <h1>thor-io.vnext</h1>
    <p>A small RTCDataChannel example</p>
    <p>Open the console and type <code>dc.Invoke("chatMessage","Hello World!")</code>. You will need 1-n browser windows created.
        <p>


            <script src="adapter.js">
            </script>
            <script src="/src/client/thor-io.client.js">
            </script>

            <script>
                var $ = function(selector, el) {
                    if (!el) el = document;
                    return el.querySelector(selector);
                }

                var rtc, dc, recorder
                document.addEventListener("DOMContentLoaded", function() {
                    var client = new ThorIO.Client.Factory(location.origin.replace(/^http/, 'ws'), ["contextBroker"]);
                    client.OnOpen = function(brokerProxy) {
                        rtc = new ThorIO.Client.WebRTC(brokerProxy, {
                            iceServers: [{
                                urls: "stun:stun.l.google.com:19302"
                            }]
                        });

                        dc = rtc.CreateDataChannel("foo")

                        dc.OnOpen = function() {
                            console.log("data channel open");
                        };
                        dc.OnClose = function() {
                            console.log("data channel close");
                        };
                        dc.On("chatMessage", function(message) {
                            console.log("got a message on a channel", message);
                        })
                        rtc.OnContextChanged = function(data) {
                            console.log("onContextChanged", data);
                            rtc.ConnectContext()
                        };
                        rtc.OnContextCreated = function(data) {
                            console.log("onContextCreated", data);
                            rtc.ChangeContext("foo");
                        };
                        rtc.OnConnectTo = function(peers) {
                            console.log("onConnectTo", peers);
                            rtc.Connect(peers);
                        };
                        brokerProxy.Connect();


                navigator.getUserMedia({audio:false,video:true}, (stream) => {
                     recorder = new ThorIO.Client.Recorder(stream,"video/webm",false);

                        console.log(recorder);


                        recorder.OnRecordComplated = function(){
                            console.log("OnRecordComplated",arguments);
                        }

                    },function(err){
                         console.log("getUserMedia error", err);
                    });


                    };
                });
            </script>

</body>

</html>